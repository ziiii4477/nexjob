<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR管理后台 - NexJob</title>
    
    <!-- CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    
    <style>
        .dashboard-container {
            padding-top: 60px;
            min-height: 100vh;
            background-color: #f8f9fa;
        }
        
        .profile-sidebar {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .profile-nav .nav-link {
            color: #333;
            padding: 0.5rem 1rem;
            margin: 0.2rem 0;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .profile-nav .nav-link:hover,
        .profile-nav .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }
        
        .profile-nav .nav-link i {
            width: 20px;
            text-align: center;
        }
        
        .profile-content {
            min-height: 600px;
        }
        
        .stats-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        
        .stats-card i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #0d6efd;
        }
        
        .resume-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .resume-card:hover {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .dropdown-toggle::after {
            margin-left: 0.5rem;
        }
        
        .current-user-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .user-btn {
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
        }
        
        .user-btn:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        
        .user-btn.dropdown-toggle::after {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <img src="../images/nexjob logo.png" alt="NexJob Logo" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="community.html">社区</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="events.html">活动</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai-assistant.html">AI助手</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">关于我们</a>
                    </li>
                </ul>
            <div class="d-flex align-items-center">
                    <div class="language-switch me-3">
                        <a href="hr-dashboard-en.html" class="btn btn-outline-secondary btn-sm">EN</a>
                    </div>
                    <div class="customer-service me-3">
                        <button class="btn btn-outline-primary btn-icon">
                            <i class="fas fa-headset"></i>
                        </button>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-primary user-btn d-flex align-items-center" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <span class="current-user-name"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i>设置</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>退出登录</a></li>
                    </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="dashboard-container">
        <div class="container py-4">
            <div class="row">
                <!-- 左侧导航 -->
                <div class="col-lg-3">
                    <div class="profile-sidebar bg-white p-4 rounded shadow-sm">
                        <div class="text-center mb-4">
                            <div class="profile-avatar mb-3 position-relative">
                                <img src="../images/user logo.jpg" alt="用户头像" class="rounded-circle" width="120" id="userAvatar">
                            </div>
                            <h5 class="mb-1" id="userName">用户名</h5>
                            <p class="text-muted small mb-3" id="userEmail">user@example.com</p>
                        </div>
                        <hr>
                        <ul class="nav flex-column profile-nav">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-section="profile-info">
                                    <i class="fas fa-user me-2"></i>个人资料
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="resume-screening">
                                    <i class="fas fa-file-alt me-2"></i>简历初筛
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="resume-review">
                                    <i class="fas fa-search me-2"></i>简历复筛
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="interview-contact">
                                    <i class="fas fa-handshake me-2"></i>联系面试
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="settings">
                                    <i class="fas fa-cog me-2"></i>账号设置
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- 右侧内容区域 -->
                <div class="col-lg-9">
                    <div class="profile-content bg-white p-4 rounded shadow-sm">
                        <!-- 个人资料部分 -->
                        <div id="profile-info">
                            <h4 class="mb-4">个人资料</h4>
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <div class="position-relative">
                                                <img src="../images/user logo.jpg" alt="用户头像" class="rounded-circle mb-3" width="80" height="80" id="profileImage">
                                            </div>
                                            <h5 class="card-title" id="profileName">HR姓名</h5>
                                            <p class="card-text text-muted" id="profileEmail">hr@example.com</p>
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#avatarModal">
                                                选择头像
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h5 class="card-title mb-4">公司信息</h5>
                                            <div class="mb-3 row">
                                                <label class="col-sm-3 col-form-label">公司名称</label>
                                                <div class="col-sm-9">
                                                    <input type="text" class="form-control" id="companyName" value="NexJob科技">
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label class="col-sm-3 col-form-label">公司规模</label>
                                                <div class="col-sm-9">
                                                    <select class="form-select" id="companySize">
                                                        <option>1-10人</option>
                                                        <option>11-50人</option>
                                                        <option selected>51-200人</option>
                                                        <option>201-500人</option>
                                                        <option>500人以上</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label class="col-sm-3 col-form-label">所在地区</label>
                                                <div class="col-sm-9">
                                                    <input type="text" class="form-control" id="companyLocation" value="瑞典隆德">
                                                </div>
                                            </div>
                                            <div class="mb-3 row">
                                                <label class="col-sm-3 col-form-label">公司网站</label>
                                                <div class="col-sm-9">
                                                    <input type="url" class="form-control" id="companyWebsite" value="https://www.nexjob.com">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">公司介绍</h5>
                                    <div class="mb-3">
                                        <label class="form-label">公司简介</label>
                                        <textarea class="form-control" id="companyDescription" rows="4">NexJob总部位于瑞典隆德，致力于连接欧洲职场和华人社区，为在欧洲的华人提供职业发展机会和社区支持。</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">公司福利</label>
                                        <textarea class="form-control" id="companyBenefits" rows="3">灵活工作时间、年度旅游、健康保险、职业发展培训</textarea>
                                    </div>
                                    <button class="btn btn-primary">保存更改</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 简历初筛部分 -->
                        <div id="resume-screening" style="display: none;">
                            <h4 class="mb-4">简历初筛</h4>
                            
                            <!-- 筛选和搜索工具栏 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <select class="form-select" id="postFilter">
                                        <option value="">所有帖子</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="screeningStatus">
                                        <option value="">所有状态</option>
                                        <option value="pending">待筛选</option>
                                        <option value="suitable">合适</option>
                                        <option value="unsuitable">不合适</option>
                                        <option value="uncertain">待定</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group h-100">
                                        <input type="text" class="form-control" id="resumeSearch" placeholder="搜索简历...">
                                        <button class="btn btn-outline-primary" onclick="searchResumes()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 简历列表 -->
                            <div class="resume-list" id="resumeList">
                                <!-- 简历卡片将通过JavaScript动态生成 -->
                            </div>

                            <!-- 分页 -->
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center" id="resumePagination">
                                    <!-- 分页将通过JavaScript动态生成 -->
                                </ul>
                            </nav>
                        </div>

                        <!-- 查看简历弹窗 -->
                        <div class="modal fade" id="resumeModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">查看简历</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="resumeContent">
                                            <!-- 简历内容将通过JavaScript动态加载 -->
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 简历复筛部分 -->
                        <div id="resume-review" style="display: none;">
                            <h4 class="mb-4">简历复筛</h4>
                            
                            <!-- 筛选工具栏 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <select class="form-select" id="jobFilterReview">
                                        <option value="">所有职位</option>
                                        <option value="frontend">前端开发工程师</option>
                                        <option value="backend">后端开发工程师</option>
                                        <option value="fullstack">全栈工程师</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="aiInterviewFilter">
                                        <option value="">全部简历</option>
                                        <option value="with-ai">已完成AI面试</option>
                                        <option value="without-ai">未完成AI面试</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group h-100">
                                        <input type="text" class="form-control" id="candidateSearch" placeholder="搜索候选人...">
                                        <button class="btn btn-outline-primary" onclick="searchCandidates()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 待复筛简历列表 -->
                            <div class="resume-review-list" id="resumeReviewList">
                                <!-- 简历卡片将通过JavaScript动态生成 -->
                            </div>

                            <!-- 分页 -->
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center" id="resumeReviewPagination">
                                    <!-- 分页将通过JavaScript动态生成 -->
                                </ul>
                            </nav>
                        </div>

                        <!-- 联系面试部分 -->
                        <div id="interview-contact" style="display: none;">
                            <h4 class="mb-4">联系面试</h4>
                            
                            <!-- 筛选工具栏 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <select class="form-select" id="jobFilterInterview">
                                        <option value="">所有职位</option>
                                        <!-- 职位选项将通过JavaScript动态生成 -->
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="contactStatus">
                                        <option value="">所有状态</option>
                                        <option value="pending">待联系</option>
                                        <option value="invited">已邀请</option>
                                        <option value="scheduled">已安排面试</option>
                                        <option value="completed">已完成面试</option>
                                        <option value="rejected">已拒绝</option>
                                        <option value="cancelled">已取消</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex">
                                        <input type="text" class="form-control me-2" id="candidateSearchInterview" placeholder="搜索候选人...">
                                        <button class="btn btn-outline-primary" onclick="searchInterviewCandidates()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 导出和批量操作按钮 -->
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <button class="btn btn-outline-secondary" onclick="toggleSelectAllCandidates()">
                                        <i class="fas fa-check-square me-1"></i>全选/取消
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-primary" onclick="exportSelectedResumes()">
                                        <i class="fas fa-download me-1"></i>导出选中简历
                                    </button>
                                    <button class="btn btn-outline-primary ms-2" onclick="exportResumesByJob()">
                                        <i class="fas fa-file-export me-1"></i>按职位导出
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 候选人列表 -->
                            <div class="candidate-list" id="candidateList">
                                <!-- 候选人卡片将通过JavaScript动态生成 -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2">正在加载候选人数据...</p>
                                </div>
                            </div>

                            <!-- 分页 -->
                            <nav class="mt-4">
                                <ul class="pagination justify-content-center" id="interviewPagination">
                                    <!-- 分页将通过JavaScript动态生成 -->
                                </ul>
                            </nav>
                        </div>

                        <!-- 面试邀请弹窗 -->
                        <div class="modal fade" id="interviewModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">发送面试邀请</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="interviewForm">
                                            <input type="hidden" id="candidateId">
                                            <div class="mb-3">
                                                <label class="form-label">候选人</label>
                                                <input type="text" class="form-control" id="candidateName" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">应聘职位</label>
                                                <input type="text" class="form-control" id="candidatePosition" readonly>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">面试类型</label>
                                                <select class="form-select" id="interviewType" required>
                                                    <option value="onsite">现场面试</option>
                                                    <option value="online">线上面试</option>
                                                    <option value="phone">电话面试</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">面试地点/链接</label>
                                                <input type="text" class="form-control" id="interviewLocation" placeholder="请输入面试地点或线上会议链接" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">建议时间（可多选）</label>
                                                <div class="row">
                                                    <div class="col-md-6 mb-2">
                                                        <input type="datetime-local" class="form-control" id="interviewTime1" required>
                                                    </div>
                                                    <div class="col-md-6 mb-2">
                                                        <input type="datetime-local" class="form-control" id="interviewTime2">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <input type="datetime-local" class="form-control" id="interviewTime3">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <input type="datetime-local" class="form-control" id="interviewTime4">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">会议链接（线上面试）</label>
                                                <input type="url" class="form-control" id="meetingLink" placeholder="例如：Zoom、Teams或其他会议平台链接">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">邀请信息</label>
                                                <textarea class="form-control" id="interviewMessage" rows="4" placeholder="请输入面试邀请信息，如面试准备事项、联系人信息等" required></textarea>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                        <button type="button" class="btn btn-primary" onclick="sendInterviewInvitation()">发送邀请</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 账号设置部分 -->
                        <div id="settings" style="display: none;">
                            <h4 class="mb-4">账号设置</h4>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="mb-4">个人信息</h5>
                                    <div class="mb-3 row">
                                        <label class="col-sm-3 col-form-label">姓名</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" value="王小明">
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-3 col-form-label">邮箱</label>
                                        <div class="col-sm-9">
                                            <input type="email" class="form-control" value="hr@nexjob.com">
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-3 col-form-label">电话</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" value="+46 123 456789">
                                    </div>
                                </div>
                                    <div class="mb-3 row">
                                        <label class="col-sm-3 col-form-label">职位</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" value="人力资源经理">
                        </div>
                    </div>
                                    <button class="btn btn-primary">保存更改</button>
                                </div>
                            </div>
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="mb-4">修改密码</h5>
                                <div class="mb-3">
                                        <label class="form-label">当前密码</label>
                                        <input type="password" class="form-control">
                                </div>
                                <div class="mb-3">
                                        <label class="form-label">新密码</label>
                                        <input type="password" class="form-control">
                                </div>
                                <div class="mb-3">
                                        <label class="form-label">确认新密码</label>
                                        <input type="password" class="form-control">
                                    </div>
                                    <button class="btn btn-primary">更新密码</button>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="mb-4">通知设置</h5>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="emailNotif" checked>
                                        <label class="form-check-label" for="emailNotif">邮件通知</label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="smsNotif">
                                        <label class="form-check-label" for="smsNotif">短信通知</label>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="newResumeNotif" checked>
                                        <label class="form-check-label" for="newResumeNotif">新简历提醒</label>
                                    </div>
                                    <button class="btn btn-primary">保存设置</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 发送私信模态框 -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">发送私信</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">收件人</label>
                        <input type="text" class="form-control" id="messageRecipient" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">消息内容</label>
                        <textarea class="form-control" rows="4" placeholder="请输入消息内容..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">快速模板</label>
                        <select class="form-select">
                            <option value="">选择消息模板...</option>
                            <option value="template1">邀请参加面试</option>
                            <option value="template2">确认面试时间</option>
                            <option value="template3">要求补充信息</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary">发送</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 头像选择模态框 -->
    <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarModalLabel">选择头像</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar7.svg" alt="头像7" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar8.svg" alt="头像8" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar9.svg" alt="头像9" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar10.svg" alt="头像10" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar11.svg" alt="头像11" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="avatar-option">
                                <img src="../images/avatars/avatar12.svg" alt="头像12" class="img-fluid rounded-circle" onclick="selectAvatar(this.src)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="../js/api-config.js"></script>
    <script>
        let currentUser = null;
        let currentApplication = null;

        // 检查登录状态
        async function checkAuth() {
            console.log('开始认证检查');

            const token = localStorage.getItem('token');
            const userType = localStorage.getItem('userType');

            console.log('存储的认证信息:', { token, userType });

            if (!token) {
                console.log('认证失败：无token');
                redirectToLogin();
                return;
            }
            
            if (userType !== 'hr') {
                console.log('求职者用户尝试访问HR页面，重定向到求职者个人资料页面');
                window.location.href = 'profile.html';
                return;
            }

            try {
                // 使用HR专用的API端点
                const response = await fetch(`${API_BASE_URL}/api/v1/hr/me`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                console.log('认证请求状态:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('认证响应数据:', data);

                if (data.success) {
                    currentUser = data.data;
                    // 同步localStorage.user，便于社区等页面读取
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserInfo();
                } else {
                    throw new Error(data.message || '认证失败');
                }
            } catch (error) {
                console.error('认证错误:', error);
                // 如果是401错误，重定向到登录页面
                if (error.message.includes('401')) {
                    console.log('认证失败：token无效或过期');
                    redirectToLogin();
                } else {
                    console.log('其他错误:', error.message);
                    alert('获取用户信息失败，请重新登录');
                    redirectToLogin();
                }
            }
        }

        function redirectToLogin() {
            localStorage.clear();
            // 返回首页
            window.location.href = '../index.html';
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            if (currentUser) {
                const userNameElement = document.querySelector('.current-user-name');
                if (userNameElement) {
                    userNameElement.textContent = currentUser.name || '用户';
                }
                
                // 更新个人资料页
                document.getElementById('profileName').textContent = currentUser.name || 'HR姓名';
                document.getElementById('profileEmail').textContent = currentUser.email || 'hr@example.com';
                document.getElementById('userName').textContent = currentUser.name || '用户名';
                document.getElementById('userEmail').textContent = currentUser.email || 'user@example.com';
                
                // 更新头像
                if (currentUser.avatar) {
                    const avatarPath = `../images/avatars/${currentUser.avatar}`;
                    const avatarElements = document.querySelectorAll('#userAvatar, #profileImage');
                    avatarElements.forEach(avatar => {
                        if (avatar) avatar.src = avatarPath;
                    });
                }
            }
        }

        // 处理退出登录
        function handleLogout() {
            localStorage.clear();
            // 返回首页
            window.location.href = '../index.html';
        }

        // 显示不同部分的内容
        function showSection(sectionId) {
            console.log('切换到部分:', sectionId);
            // 隐藏所有部分
            document.querySelectorAll('.profile-content > div').forEach(div => {
                div.style.display = 'none';
            });
            
            // 显示选中的部分
            document.getElementById(sectionId).style.display = 'block';
            
            // 更新导航项的激活状态
            document.querySelectorAll('.profile-nav .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });

            // 根据部分ID加载相应的数据
            if (sectionId === 'interview-contact') {
                console.log('正在加载联系面试数据...');
                loadInterviewCandidates();
            }
        }

        // 简历初筛相关函数
        function markResume(status, resumeId) {
            // 实现简历标记逻辑
            console.log(`Marking resume ${resumeId} as ${status}`);
            // 这里可以添加AJAX请求来更新后端数据
        }

        function viewResume(resumeId) {
            // 实现查看简历逻辑
            console.log(`Viewing resume ${resumeId}`);
            // 这里可以添加打开简历详情的逻辑
        }

        // 简历复筛相关函数
        function viewAiInterview(candidateId) {
            // 切换AI面试报告的显示状态
            const reportElement = document.getElementById(`aiReport-${candidateId}`);
            if (reportElement) {
                reportElement.classList.toggle('show');
            }
        }

        function markReview(status, candidateId) {
            // 实现复筛标记逻辑
            console.log(`Marking review for ${candidateId} as ${status}`);
            // 这里可以添加AJAX请求来更新后端数据
        }

        // 联系面试相关函数
        function exportSelectedResumes() {
            // 实现导出选中简历的逻辑
            console.log('Exporting selected resumes');
            // 这里可以添加导出功能的实现
        }

        function viewCandidateDetail(candidateId) {
            // 实现查看候选人详情的逻辑
            console.log(`Viewing candidate ${candidateId} details`);
            // 这里可以添加打开候选人详情的逻辑
        }

        function sendMessage(candidateId) {
            // 显示发送私信模态框
            const modal = new bootstrap.Modal(document.getElementById('messageModal'));
            // 设置收件人
            document.getElementById('messageRecipient').value = candidateId === 'candidate1' ? '张三' : '李四';
            modal.show();
        }

        // 强制关闭模态框并重置页面状态
        function forceCloseModal() {
            try {
                // 1. 尝试使用Bootstrap API关闭模态框
                const modalElement = document.getElementById('avatarModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            } catch (e) {
                console.error('关闭模态框出错:', e);
            }
            
            // 2. 强制重置DOM状态
            document.body.className = document.body.className.replace(/\bmodal-open\b/, '');
            
            // 3. 移除所有模态框背景
            try {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    backdrop.parentNode.removeChild(backdrop);
                });
            } catch (e) {
                console.error('移除背景出错:', e);
            }
            
            // 4. 重置模态框状态
            try {
                const modalElement = document.getElementById('avatarModal');
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                modalElement.removeAttribute('role');
            } catch (e) {
                console.error('重置模态框状态出错:', e);
            }
            
            // 5. 强制重置body样式
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // 6. 重置navbar位置和样式
            try {
                const navbar = document.querySelector('.navbar.fixed-top');
                if (navbar) {
                    navbar.style.removeProperty('padding-right');
                    navbar.style.removeProperty('margin-right');
                }
            } catch (e) {
                console.error('重置导航栏样式出错:', e);
            }
            
            // 7. 最后的手段 - 添加一个小延迟后强制启用滚动和重置所有样式
            setTimeout(() => {
                // 重置body样式
                document.body.style.overflow = 'visible';
                document.body.style.paddingRight = '0';
                
                // 重置html样式
                document.documentElement.style.overflow = 'auto';
                document.documentElement.style.height = 'auto';
                
                // 重置所有容器的位置
                try {
                    document.querySelectorAll('.container').forEach(container => {
                        container.style.paddingRight = '';
                        container.style.marginRight = '';
                    });
                } catch (e) {
                    console.error('重置容器样式出错:', e);
                }
                
                // 重置页面布局，强制浏览器重排
                document.body.style.display = 'none';
                // 强制回流
                void document.body.offsetHeight;
                document.body.style.display = '';
                
                // 尝试触发window的resize事件，有时这可以重置页面状态
                try {
                    window.dispatchEvent(new Event('resize'));
                } catch (e) {
                    console.error('触发resize事件出错:', e);
                }
            }, 100);
        }

        // 头像选择功能
        function selectAvatar(avatarSrc) {
            // 从完整URL中提取文件名
            const avatarFileName = avatarSrc.split('/').pop();
            
            // 更新显示的头像（使用相对路径）
            const avatarPath = `../images/avatars/${avatarFileName}`;
            
            // 更新所有头像预览
            const userAvatars = document.querySelectorAll('#userAvatar, #profileImage');
            userAvatars.forEach(avatar => {
                if (avatar) avatar.src = avatarPath;
            });
            
            // 获取用户类型和token
            const token = localStorage.getItem('token');
            
            if (!token) {
                alert('请先登录');
                return;
            }

            // 先关闭模态框，确保用户体验
            forceCloseModal();

            // 构建API请求URL
            const apiEndpoint = 'http://localhost:3001/api/v1/auth/updatedetails';

            // 发送更新请求
            fetch(apiEndpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    avatar: avatarFileName  // 只发送文件名
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新本地存储的用户信息
                    if (currentUser) {
                        currentUser.avatar = avatarFileName;
                    }
                    
                    // 同时更新localStorage中的user对象
                    const storedUser = JSON.parse(localStorage.getItem('user') || '{}');
                    storedUser.avatar = avatarFileName;
                    localStorage.setItem('user', JSON.stringify(storedUser));

                    // 显示成功消息
                    console.log('头像更新成功');
                } else {
                    throw new Error(data.error || '更新头像失败');
                }
            })
            .catch(error => {
                console.error('更新头像失败:', error);
                alert('更新头像失败，请稍后重试');
            });
        }

        // 监听导航点击事件和筛选器变化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查登录状态
            checkAuth();
            
            // 绑定导航点击事件
            document.querySelectorAll('.profile-nav .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                    
                    // 如果点击的是简历初筛，加载简历数据
                    if (sectionId === 'resume-screening') {
                        loadResumeApplications();
                    }
                    
                    // 如果点击的是简历复筛，加载待复筛简历数据
                    if (sectionId === 'resume-review') {
                        loadReviewApplications();
                    }
                });
            });
            
            // 添加简历初筛页面的筛选器监听
            const postFilter = document.getElementById('postFilter');
            const statusFilter = document.getElementById('screeningStatus');
            const searchInput = document.getElementById('resumeSearch');
            const searchButton = document.querySelector('#resumeSearch + button');
            
            if (postFilter) {
                postFilter.addEventListener('change', searchResumes);
                console.log('已添加帖子筛选监听器');
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', searchResumes);
                console.log('已添加状态筛选监听器');
            }
            
            if (searchButton) {
                searchButton.addEventListener('click', searchResumes);
                console.log('已添加搜索按钮监听器');
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchResumes();
                    }
                });
                console.log('已添加搜索框回车监听器');
            }
            
            // 添加简历复筛页面的筛选器监听
            const jobFilterReview = document.getElementById('jobFilterReview');
            const aiInterviewFilter = document.getElementById('aiInterviewFilter');
            const candidateSearch = document.getElementById('candidateSearch');
            const candidateSearchButton = document.querySelector('#candidateSearch + button');
            
            if (jobFilterReview) {
                jobFilterReview.addEventListener('change', searchCandidates);
                console.log('已添加职位筛选监听器');
            }
            
            if (aiInterviewFilter) {
                aiInterviewFilter.addEventListener('change', searchCandidates);
                console.log('已添加AI面试筛选监听器');
            }
            
            if (candidateSearchButton) {
                candidateSearchButton.addEventListener('click', searchCandidates);
                console.log('已添加搜索按钮监听器');
            }
            
            if (candidateSearch) {
                candidateSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchCandidates();
                    }
                });
                console.log('已添加搜索框回车监听器');
            }
            
            // 初始化加载
            loadHRPosts();
            
            // 默认显示个人资料页
            showSection('profile-info');
            
            // 延迟加载简历数据，确保DOM已完全加载
            setTimeout(() => {
                const currentSection = document.querySelector('.profile-nav .nav-link.active').getAttribute('data-section');
                if (currentSection === 'resume-screening') {
                    loadResumeApplications();
                } else if (currentSection === 'resume-review') {
                    loadReviewApplications();
                }
            }, 1000);
        });

        // 切换页面
        function changePage(page, paginationId) {
            if (paginationId === 'resumeReviewPagination') {
                loadReviewApplications('', '', '', page);
            } else if (paginationId === 'resumePagination') {
                // 处理简历初筛的分页
                const postId = document.getElementById('postFilter').value;
                const status = document.getElementById('screeningStatus').value;
                const search = document.getElementById('resumeSearch').value;
                
                // 这里需要实现简历初筛的分页功能
                // 暂时留空
            }
        }

        // 加载简历申请列表
        async function loadResumeApplications(postId = '', status = '', search = '', page = 1) {
            try {
                const resumeList = document.getElementById('resumeList');
                resumeList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载简历数据...</p></div>';

                // 构建URL参数
                const params = new URLSearchParams();
                if (postId) params.append('postId', postId);
                if (status) params.append('status', status);
                if (search) params.append('search', search);
                params.append('page', page);
                params.append('limit', 10);
                params.append('sort', 'createdAt'); // 按创建时间排序
                params.append('order', 'asc'); // 升序（早的在前）
                params.append('priorityStatus', 'unread'); // 优先显示未读状态

                const url = `http://localhost:3001/api/v1/applications?${params.toString()}`;
                console.log('请求URL:', url);

                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('获取到的简历数据:', data);

                if (!data.data || data.data.length === 0) {
                    resumeList.innerHTML = '<div class="alert alert-info">暂无符合条件的简历</div>';
                    return;
                }

                resumeList.innerHTML = '';
                data.data.forEach(application => {
                    const statusBadge = getStatusBadge(application.status);
                    const postTitle = application.post ? application.post.title : '未知帖子';
                    
                    resumeList.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">${application.applicant ? application.applicant.name : '未知姓名'}</h5>
                                        <p class="text-muted mb-2">应聘：${postTitle}</p>
                                        <small class="text-muted">投递时间：${new Date(application.createdAt).toLocaleString()}</small>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-2">
                                            ${statusBadge}
                                        </div>
                                        <div>
                                            <button class="btn btn-outline-primary btn-sm" onclick="viewResume('${application._id}')">
                                                <i class="fas fa-eye me-1"></i>查看简历
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // 更新分页
                console.log('简历列表数据:', {
                    count: data.data.length
                });
                
                // 使用实际数量
                updatePagination({
                    page: 1,
                    total: data.data.length
                }, 'resumePagination');

            } catch (error) {
                console.error('获取简历申请数据失败:', error);
                resumeList.innerHTML = `<div class="alert alert-danger">获取简历数据失败: ${error.message}</div>`;
            }
        }

        // 查看简历
        async function viewResume(applicationId) {
            try {
                console.log('查看简历ID:', applicationId);
                
                const resumeContent = document.getElementById('resumeContent');
                resumeContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载简历...</p></div>';
                
                // 显示模态框
                const resumeModal = new bootstrap.Modal(document.getElementById('resumeModal'));
                resumeModal.show();
                
                const response = await fetch(`http://localhost:3001/api/v1/applications/${applicationId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('获取到的简历数据:', data);
                
                if (!data.success || !data.data) {
                    throw new Error('获取简历数据失败');
                }
                
                currentApplication = data.data;
                
                // 检查简历数据完整性
                if (!currentApplication.applicant || !currentApplication.resume) {
                    resumeContent.innerHTML = '<div class="alert alert-warning">简历数据不完整</div>';
                    return;
                }
                
                console.log('简历详情:', {
                    resumeId: currentApplication.resume._id,
                    filename: currentApplication.resume.filename,
                    path: currentApplication.resume.path,
                    mimeType: currentApplication.resume.mimeType
                });
                
                // 构建简历内容
                let resumeHtml = `
                    <div class="mb-4">
                        <h4>${currentApplication.applicant.name || '未知姓名'}的简历</h4>
                        <p class="text-muted">联系方式：${currentApplication.applicant.email || '未提供'}</p>
                    </div>
                `;
                
                // 添加简历内容
                if (currentApplication.resume.content) {
                    resumeHtml += `
                        <div class="resume-body">
                            ${currentApplication.resume.content}
                        </div>
                    `;
                } else if (currentApplication.resume.path) {
                    // 构建正确的文件URL，使用专门的简历预览API
                    const fileUrl = `http://localhost:3001/api/v1/resumes/${currentApplication.resume._id}/view`;
                    const fileName = currentApplication.resume.originalName || currentApplication.resume.filename || '简历文件';
                    
                    console.log('预览URL:', fileUrl);
                    
                    // 使用iframe直接在当前页面预览
                    resumeHtml += `
                        <div class="resume-body">
                            <p class="mb-3">简历文件: ${fileName}</p>
                            <div style="position: relative; height: 70vh; overflow: hidden;">
                                <iframe src="${fileUrl}?token=${localStorage.getItem('token')}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid #dee2e6;"></iframe>
                            </div>
                        </div>
                    `;
                } else {
                    resumeHtml += `<div class="alert alert-info">暂无简历内容</div>`;
                }
                
                resumeContent.innerHTML = resumeHtml;
                
                // 更新模态框底部按钮
                const modalFooter = document.querySelector('#resumeModal .modal-footer');
                if (modalFooter) {
                    // 判断当前是否在复筛页面
                    const currentSection = document.querySelector('.profile-nav .nav-link.active').getAttribute('data-section');
                    if (currentSection === 'resume-review') {
                        // 复筛页面只显示"合适"和"不合适"按钮
                        modalFooter.innerHTML = `
                            <div class="btn-group me-auto">
                                <button class="btn btn-success" onclick="updateApplicationStatus('${currentApplication._id}', 'suitable')">合适</button>
                                <button class="btn btn-danger" onclick="updateApplicationStatus('${currentApplication._id}', 'unsuitable')">不合适</button>
                            </div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        `;
                    } else {
                        // 初筛页面显示"合适"、"不合适"和"待定"按钮
                        modalFooter.innerHTML = `
                            <div class="btn-group me-auto">
                                <button class="btn btn-success" onclick="updateApplicationStatus('${currentApplication._id}', 'suitable')">合适</button>
                                <button class="btn btn-danger" onclick="updateApplicationStatus('${currentApplication._id}', 'unsuitable')">不合适</button>
                                <button class="btn btn-warning" onclick="updateApplicationStatus('${currentApplication._id}', 'uncertain')">待定</button>
                            </div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('获取简历详情失败:', error);
                const resumeContent = document.getElementById('resumeContent');
                resumeContent.innerHTML = `<div class="alert alert-danger">获取简历详情失败: ${error.message}</div>`;
            }
        }

        // 更新申请状态
        async function updateApplicationStatus(applicationId, status) {
            const statusMap = {
                'suitable': 'suitable',
                'unsuitable': 'unsuitable',
                'uncertain': 'uncertain'
            };

            const dbStatus = statusMap[status] || status;

            const response = await fetch(`http://localhost:3001/api/v1/applications/${applicationId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: dbStatus })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('状态更新响应:', data);

            if (data.success) {
                // 根据当前页面重新加载数据
                const currentSection = document.querySelector('.profile-nav .nav-link.active').getAttribute('data-section');
                if (currentSection === 'resume-screening') {
                    searchResumes();
                } else if (currentSection === 'resume-review') {
                    searchCandidates();
                }
            } else {
                throw new Error(data.message || '更新失败');
            }
        }

        // 加载HR的帖子列表
        async function loadHRPosts() {
            try {
                console.log('开始加载HR帖子列表');
                
                const response = await fetch('http://localhost:3001/api/v1/community-posts/my-posts', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('获取到的帖子数据:', data);
                
                const postFilter = document.getElementById('postFilter');
                const jobFilterReview = document.getElementById('jobFilterReview');
                
                postFilter.innerHTML = '<option value="">所有帖子</option>';
                jobFilterReview.innerHTML = '<option value="">所有职位</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(post => {
                        // 注意：后端可能使用quickApply或allowQuickApply作为字段名
                        if (post.quickApply || post.allowQuickApply) {
                            postFilter.innerHTML += `<option value="${post._id}">${post.title}</option>`;
                            jobFilterReview.innerHTML += `<option value="${post._id}">${post.title}</option>`;
                        }
                    });
                    console.log('加载了', data.data.length, '个帖子');
                } else {
                    console.log('没有找到帖子数据');
                }
            } catch (error) {
                console.error('加载帖子列表失败:', error);
                const postFilter = document.getElementById('postFilter');
                postFilter.innerHTML = '<option value="">加载帖子失败</option>';
                const jobFilterReview = document.getElementById('jobFilterReview');
                jobFilterReview.innerHTML = '<option value="">加载职位失败</option>';
            }
        }

        // 获取状态徽章HTML
        function getStatusBadge(status) {
            const statusMap = {
                'suitable': ['bg-success', '合适'],
                'unsuitable': ['bg-danger', '不合适'],
                'uncertain': ['bg-warning', '待定']
            };
            
            const [bgClass, text] = statusMap[status] || ['bg-secondary', '待筛选'];
            return `<span class="badge ${bgClass}">${text}</span>`;
        }

        // 搜索简历
        function searchResumes() {
            console.log('执行搜索...');
            const postId = document.getElementById('postFilter').value;
            const status = document.getElementById('screeningStatus').value;
            const search = document.getElementById('resumeSearch').value;
            
            console.log('搜索条件:', { postId, status, search });
            loadResumeApplications(postId, status, search);
        }

        // 加载待复筛简历列表
        async function loadReviewApplications(jobId = '', hasAiInterview = '', search = '', page = 1) {
            const reviewList = document.getElementById('resumeReviewList');
            if (!reviewList) {
                console.error('找不到resumeReviewList元素');
                return;
            }

            try {
                reviewList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载简历数据...</p></div>';

                // 构建URL参数
                const params = new URLSearchParams();
                if (jobId) params.append('postId', jobId);
                params.append('status', 'uncertain'); // 只显示待定状态的简历
                params.append('page', page);
                params.append('limit', 10);
                params.append('sort', 'createdAt'); // 按创建时间排序
                params.append('order', 'asc'); // 升序（早的在前）

                const url = `http://localhost:3001/api/v1/applications?${params.toString()}`;
                console.log('请求URL:', url);

                const token = localStorage.getItem('token');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('获取到的简历数据:', data);

                // 在前端进行额外的筛选
                let filteredApplications = data.data;

                // 根据AI面试状态筛选
                if (hasAiInterview === 'with-ai') {
                    filteredApplications = filteredApplications.filter(app => app.aiInterview);
                } else if (hasAiInterview === 'without-ai') {
                    filteredApplications = filteredApplications.filter(app => !app.aiInterview);
                }

                // 根据搜索关键词筛选
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredApplications = filteredApplications.filter(app => {
                        const nameMatch = app.applicant?.name?.toLowerCase().includes(searchLower);
                        const postMatch = app.post?.title?.toLowerCase().includes(searchLower);
                        const idMatch = app._id.toLowerCase().includes(searchLower);
                        return nameMatch || postMatch || idMatch;
                    });
                }

                if (!filteredApplications || filteredApplications.length === 0) {
                    reviewList.innerHTML = '<div class="alert alert-info">暂无待复筛的简历</div>';
                    return;
                }

                reviewList.innerHTML = '';
                filteredApplications.forEach(application => {
                    const hasAiInterview = application.aiInterview ? '<span class="badge bg-info ms-2">已完成AI面试</span>' : '';
                    const applicationId = application._id;
                    
                    reviewList.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h5 class="card-title mb-1">${application.applicant ? application.applicant.name : '未知姓名'}</h5>
                                                <p class="text-muted mb-2">应聘：${application.post ? application.post.title : '未知职位'}</p>
                                                <div class="mb-2">
                                                    ${hasAiInterview}
                                                </div>
                                                <small class="text-muted d-block">申请编号：${applicationId}</small>
                                                <small class="text-muted d-block">初筛时间：${new Date(application.updatedAt).toLocaleString()}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex flex-column align-items-end">
                                            <button class="btn btn-secondary btn-sm w-100 mb-2" disabled>
                                                <i class="fas fa-robot me-1"></i>问AI@${applicationId.substring(0, 4)}****${applicationId.substring(applicationId.length - 4)}
                                            </button>
                                            <button class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="viewResume('${applicationId}')">
                                                <i class="fas fa-file-alt me-1"></i>查看简历
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // 更新分页
                console.log('复筛列表数据:', {
                    filteredCount: filteredApplications.length,
                    originalCount: data.data.length
                });
                
                // 始终使用过滤后的实际数量
                updatePagination({
                    page: 1, // 过滤后始终显示第一页
                    total: filteredApplications.length // 使用实际数量
                }, 'resumeReviewPagination');

            } catch (error) {
                console.error('获取待复筛简历数据失败:', error);
                reviewList.innerHTML = `<div class="alert alert-danger">获取简历数据失败: ${error.message}</div>`;
            }
        }

        // 搜索候选人
        function searchCandidates() {
            console.log('执行候选人搜索...');
            const jobId = document.getElementById('jobFilterReview').value;
            const hasAiInterview = document.getElementById('aiInterviewFilter').value;
            const search = document.getElementById('candidateSearch').value;
            
            console.log('搜索条件:', { jobId, hasAiInterview, search });
            loadReviewApplications(jobId, hasAiInterview, search, 1); // 重置到第一页
        }

        // 更新分页 - 完全重写版本
        function updatePagination(pagination, paginationId) {
            const paginationElement = document.getElementById(paginationId);
            if (!paginationElement) return;

            // 提取分页数据
            const { page = 1, total = 0 } = pagination;
            
            // 强制设置每页显示10条
            const itemsPerPage = 10;
            
            // 计算实际页数
            const actualPages = Math.max(1, Math.ceil(total / itemsPerPage));
            
            console.log('分页详细信息:', {
                paginationId,
                total,
                itemsPerPage,
                actualPages,
                currentPage: page
            });

            // 构建分页HTML
            let html = '';
            
            // 总数显示
            html += `
                <li class="page-item disabled">
                    <span class="page-link">共 ${total} 条</span>
                </li>
            `;
            
            // 如果数据量不足一页，只显示禁用的导航
            if (total <= itemsPerPage) {
                html += `
                    <li class="page-item disabled">
                        <a class="page-link" href="#">上一页</a>
                    </li>
                    <li class="page-item active">
                        <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item disabled">
                        <a class="page-link" href="#">下一页</a>
                    </li>
                `;
                
                paginationElement.innerHTML = html;
                return;
            }
            
            // 上一页按钮
            html += `
                <li class="page-item ${page <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" ${page > 1 ? `onclick="event.preventDefault(); changePage(${page - 1}, '${paginationId}')"` : ''}>上一页</a>
                </li>
            `;
            
            // 页码按钮
            for (let i = 1; i <= actualPages; i++) {
                html += `
                    <li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); changePage(${i}, '${paginationId}')">${i}</a>
                    </li>
                `;
            }
            
            // 下一页按钮
            html += `
                <li class="page-item ${page >= actualPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" ${page < actualPages ? `onclick="event.preventDefault(); changePage(${page + 1}, '${paginationId}')"` : ''}>下一页</a>
                </li>
            `;
            
            paginationElement.innerHTML = html;
        }

        // 添加在新窗口打开简历的函数
        function openResumeInNewWindow(url) {
            // 添加token到URL
            const token = localStorage.getItem('token');
            const urlWithToken = `${url}?token=${token}`;
            
            // 在新窗口中打开
            const newWindow = window.open('about:blank', '_blank');
            if (newWindow) {
                // 创建一个表单并提交，这样可以发送带Authorization头的请求
                const form = document.createElement('form');
                form.method = 'GET';
                form.action = url;
                form.target = '_blank';
                
                // 添加token作为隐藏字段
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'token';
                tokenInput.value = token;
                form.appendChild(tokenInput);
                
                // 添加到body并提交
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
            } else {
                // 如果无法打开新窗口，可能是被浏览器阻止了
                alert('无法打开新窗口，请检查您的浏览器是否阻止了弹出窗口。');
                // 作为备选方案，尝试直接在当前窗口打开
                window.location.href = urlWithToken;
            }
        }

        // 加载待面试候选人列表
        async function loadInterviewCandidates(postId = '', interviewStatus = '', search = '', page = 1) {
            console.log('开始加载候选人列表，参数:', { postId, interviewStatus, search, page });
            
            try {
                const candidateList = document.getElementById('candidateList');
                if (!candidateList) {
                    console.error('找不到candidateList元素');
                    return;
                }

                candidateList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载候选人数据...</p></div>';

                // 构建URL参数
                const params = new URLSearchParams();
                if (postId) params.append('postId', postId);
                params.append('status', 'suitable');
                if (interviewStatus) params.append('interviewStatus', interviewStatus);
                if (search) params.append('search', search);
                params.append('page', page);
                params.append('limit', 10);

                const url = `http://localhost:3001/api/v1/applications?${params.toString()}`;
                console.log('发送请求到URL:', url);

                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('未找到认证令牌');
                }

                console.log('开始发送网络请求...');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('收到响应:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('解析响应数据:', data);

                if (!data.success) {
                    throw new Error(data.message || '获取数据失败');
                }

                if (!data.data || data.data.length === 0) {
                    console.log('没有找到候选人数据');
                    candidateList.innerHTML = '<div class="alert alert-info">暂无符合条件的候选人</div>';
                    return;
                }

                console.log('开始渲染候选人列表...');
                candidateList.innerHTML = '';
                data.data.forEach(candidate => {
                    const interviewStatusBadge = getInterviewStatusBadge(candidate.interviewStatus || 'pending');
                    const applicationId = candidate._id;
                    const postTitle = candidate.post ? candidate.post.title : '未知职位';
                    const candidateName = candidate.applicant ? candidate.applicant.name : '未知姓名';
                    const experience = candidate.applicant && candidate.applicant.experience ? `${candidate.applicant.experience}年经验` : '经验未知';
                    const education = candidate.applicant && candidate.applicant.education ? candidate.applicant.education : '学历未知';
                    
                    candidateList.innerHTML += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input candidate-checkbox" type="checkbox" value="${applicationId}" id="candidate${applicationId}Check">
                                            <label class="form-check-label" for="candidate${applicationId}Check">
                                                <h5 class="mb-1">${candidateName}</h5>
                                                <p class="text-muted mb-2">应聘：${postTitle}</p>
                                                <div class="mb-2">
                                                    <span class="badge bg-primary me-2">${experience}</span>
                                                    <span class="badge bg-secondary me-2">${education}</span>
                                                    ${interviewStatusBadge}
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-md-end">
                                        <button class="btn btn-outline-primary btn-sm me-2" onclick="viewCandidateDetail('${applicationId}')">
                                            <i class="fas fa-eye me-1"></i>查看简历
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="showInterviewModal('${applicationId}', '${candidateName}', '${postTitle}')">
                                            <i class="fas fa-envelope me-1"></i>发送面试邀请
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                console.log('更新分页...');
                updatePagination({
                    page: page,
                    total: data.count || data.data.length
                }, 'interviewPagination');

                console.log('候选人列表加载完成');

            } catch (error) {
                console.error('获取候选人数据失败:', error);
                const candidateList = document.getElementById('candidateList');
                if (candidateList) {
                    candidateList.innerHTML = `<div class="alert alert-danger">获取候选人数据失败: ${error.message}</div>`;
                }
            }
        }

        // 获取面试状态徽章
        function getInterviewStatusBadge(status) {
            const statusMap = {
                'pending': ['bg-warning', '待联系'],
                'invited': ['bg-info', '已邀请'],
                'scheduled': ['bg-success', '已安排面试'],
                'completed': ['bg-primary', '已完成面试'],
                'rejected': ['bg-danger', '已拒绝'],
                'cancelled': ['bg-secondary', '已取消']
            };
            
            const [bgClass, text] = statusMap[status] || ['bg-warning', '待联系'];
            return `<span class="badge ${bgClass}">${text}</span>`;
        }

        // 搜索待面试候选人
        function searchInterviewCandidates() {
            const postId = document.getElementById('jobFilterInterview').value;
            const interviewStatus = document.getElementById('contactStatus').value;
            const search = document.getElementById('candidateSearchInterview').value;
            
            console.log('搜索条件:', { postId, interviewStatus, search });
            loadInterviewCandidates(postId, interviewStatus, search);
        }

        // 查看候选人详情（简历）
        function viewCandidateDetail(applicationId) {
            // 复用已有的查看简历功能
            viewResume(applicationId);
        }

        // 显示面试邀请弹窗
        function showInterviewModal(applicationId, candidateName, position) {
            document.getElementById('candidateId').value = applicationId;
            document.getElementById('candidateName').value = candidateName;
            document.getElementById('candidatePosition').value = position;
            
            // 设置默认面试时间（当前时间往后推1天、2天、3天、4天）
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);
            
            const dayAfterTomorrow = new Date(now);
            dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
            dayAfterTomorrow.setHours(14, 0, 0, 0);
            
            const thirdDay = new Date(now);
            thirdDay.setDate(thirdDay.getDate() + 3);
            thirdDay.setHours(10, 0, 0, 0);
            
            const fourthDay = new Date(now);
            fourthDay.setDate(fourthDay.getDate() + 4);
            fourthDay.setHours(14, 0, 0, 0);
            
            document.getElementById('interviewTime1').value = formatDateTimeForInput(tomorrow);
            document.getElementById('interviewTime2').value = formatDateTimeForInput(dayAfterTomorrow);
            document.getElementById('interviewTime3').value = formatDateTimeForInput(thirdDay);
            document.getElementById('interviewTime4').value = formatDateTimeForInput(fourthDay);
            
            // 清空其他字段
            document.getElementById('interviewType').value = 'onsite';
            document.getElementById('interviewLocation').value = '';
            document.getElementById('meetingLink').value = '';
            document.getElementById('interviewMessage').value = '';
            
            // 显示弹窗
            const interviewModal = new bootstrap.Modal(document.getElementById('interviewModal'));
            interviewModal.show();
        }

        // 格式化日期时间为input元素的格式
        function formatDateTimeForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // 发送面试邀请
        async function sendInterviewInvitation() {
            try {
                const applicationId = document.getElementById('candidateId').value;
                const interviewType = document.getElementById('interviewType').value;
                const location = document.getElementById('interviewLocation').value;
                const message = document.getElementById('interviewMessage').value;
                const meetingLink = document.getElementById('meetingLink').value;
                
                // 收集所有有效的面试时间
                const proposedTime = [];
                for (let i = 1; i <= 4; i++) {
                    const timeInput = document.getElementById(`interviewTime${i}`);
                    if (timeInput && timeInput.value) {
                        proposedTime.push(new Date(timeInput.value).toISOString());
                    }
                }
                
                if (proposedTime.length === 0) {
                    alert('请至少提供一个面试时间');
                    return;
                }
                
                // 发送请求
                const response = await fetch(`http://localhost:3001/api/v1/applications/${applicationId}/interview-invitation`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interviewType,
                        location,
                        message,
                        proposedTime,
                        meetingLink
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('面试邀请发送成功:', data);
                
                // 关闭弹窗
                const interviewModal = bootstrap.Modal.getInstance(document.getElementById('interviewModal'));
                interviewModal.hide();
                
                // 显示成功消息
                alert('面试邀请已发送');
                
                // 重新加载候选人列表
                searchInterviewCandidates();
                
            } catch (error) {
                console.error('发送面试邀请失败:', error);
                alert(`发送面试邀请失败: ${error.message}`);
            }
        }

        // 批量导出选中的简历
        async function exportSelectedResumes() {
            try {
                const checkboxes = document.querySelectorAll('.candidate-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('请至少选择一个候选人');
                    return;
                }
                
                const applicationIds = Array.from(checkboxes).map(cb => cb.value);
                console.log('选中的候选人ID:', applicationIds);
                
                // 发送请求
                const response = await fetch('http://localhost:3001/api/v1/applications/export-resumes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ applicationIds })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('简历导出成功:', data);
                
                // TODO: 处理导出结果，可能需要下载文件
                alert(`已成功导出 ${data.count} 份简历，请在导出记录中查看`);
                
            } catch (error) {
                console.error('导出简历失败:', error);
                alert(`导出简历失败: ${error.message}`);
            }
        }

        // 按职位导出简历
        async function exportResumesByJob() {
            try {
                const postId = document.getElementById('jobFilterInterview').value;
                if (!postId) {
                    alert('请先选择一个职位');
                    return;
                }
                
                // 发送请求
                const response = await fetch('http://localhost:3001/api/v1/applications/export-resumes', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ postId })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('简历导出成功:', data);
                
                // TODO: 处理导出结果，可能需要下载文件
                alert(`已成功导出 ${data.count} 份简历，请在导出记录中查看`);
                
            } catch (error) {
                console.error('导出简历失败:', error);
                alert(`导出简历失败: ${error.message}`);
            }
        }

        // 全选/取消全选候选人
        function toggleSelectAllCandidates() {
            const checkboxes = document.querySelectorAll('.candidate-checkbox');
            const anyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = anyUnchecked;
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // 添加面试候选人页面的筛选器监听
            const jobFilterInterview = document.getElementById('jobFilterInterview');
            const contactStatus = document.getElementById('contactStatus');
            const candidateSearchInterview = document.getElementById('candidateSearchInterview');
            const candidateSearchInterviewButton = document.querySelector('#candidateSearchInterview + button');
            
            if (jobFilterInterview) {
                jobFilterInterview.addEventListener('change', searchInterviewCandidates);
                console.log('已添加面试职位筛选监听器');
            }
            
            if (contactStatus) {
                contactStatus.addEventListener('change', searchInterviewCandidates);
                console.log('已添加联系状态筛选监听器');
            }
            
            if (candidateSearchInterviewButton) {
                candidateSearchInterviewButton.addEventListener('click', searchInterviewCandidates);
                console.log('已添加候选人搜索按钮监听器');
            }
            
            if (candidateSearchInterview) {
                candidateSearchInterview.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchInterviewCandidates();
                    }
                });
                console.log('已添加候选人搜索框回车监听器');
            }
            
            // ... existing code ...
            
            // 延迟加载数据
            setTimeout(() => {
                const currentSection = document.querySelector('.profile-nav .nav-link.active').getAttribute('data-section');
                // ... existing code ...
                if (currentSection === 'interview-contact') {
                    loadInterviewCandidates();
                }
            }, 1000);
        });
    </script>
</body>
</html> 